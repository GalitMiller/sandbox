<% javascript :footer, 'sparkline', 'highcharts' %>

<%= title "System Overview" do %>
	<%= menu_item "<span class='glyphicon glyphicon-save-file' aria-hidden='true'></span> Export To PDF".html_safe,
		dashboard_path(:range => params[:range] == 'today' ? 'now' : params[:range], :format => :pdf), nil, { :class => 'dashboard' } %>
	<%= menu_item "<span class='glyphicon glyphicon glyphicon-refresh' aria-hidden='true'></span> Force Cache Update".html_safe,
		force_cache_path, nil, {:class => 'force-cache-update'
  		} if Bricata::Worker.running? %>


<% end %>

<div id='dashboard'>
	<div class='main row12'>
		<div class="charts-menu row12">

			<div class='dashboard-menu dropdown' role='presentation'>
        		<span class='dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' role='button' aria-expanded='false'>
                   	&nbsp;
                	<span class='glyphicon glyphicon-triangle-bottom' aria-hidden='true'></span>
                </span>
        		<ul class='dropdown-menu' role='menu' aria-labelledby='drop6'>
        			<li role='presentation' class='<%= "active" if @range == 'last_24' %> add_tipsy' title="<%= time_range_title(:last_24) %>"><%= link_to "Last 24", dashboard_path(:range => :last_24), :role => 'menuitem' %></li>
        			<li role='presentation' class='<%= "active" if @range == 'today' %> add_tipsy' title="<%= time_range_title(:today) %>"><%= link_to "Today", dashboard_path(:range => :today) %></li>
        			<li role='presentation' class='<%= "active" if @range == 'yesterday' %> add_tipsy' title="<%= time_range_title(:yesterday) %>"><%= link_to "Yesterday", dashboard_path(:range => :yesterday) %></li>

        			<% if @now.beginning_of_week.day == @now.day %>
        				<li role='presentation' class='<%= "active" if @range == 'last_week' %> add_tipsy' title="<%= time_range_title(:last_week) %>"><%= link_to "Last Week", dashboard_path(:range => :last_week) %></li>
        			<% else %>
        				<li role='presentation' class='<%= "active" if @range == 'week' %> add_tipsy' title="<%= time_range_title(:week) %>"><%= link_to "This Week", dashboard_path(:range => :week) %></li>
        			<% end %>

        			<% if @now.day == 1 %>
        				<li role='presentation' class='<%= "active" if @range == 'last_month' %> add_tipsy' title="<%= time_range_title(:last_month) %>"><%= link_to "Last Month", dashboard_path(:range => :last_month) %></li>
        			<% else %>
        				<li role='presentation' class='<%= "active" if @range == 'month' %> add_tipsy' title="<%= time_range_title(:month) %>"><%= link_to "This Month", dashboard_path(:range => :month) %></li>
        			<% end %>
        				<li role='presentation' class='<%= "active" if @range == 'quarter' %> add_tipsy' title="<%= time_range_title(:quarter) %>"><%= link_to "This Quarter", dashboard_path(:range => :quarter) %></li>
        				<li role='presentation' class='<%= "active" if @range == 'year' %> add_tipsy' title="<%= time_range_title(:year) %>"><%= link_to "This Year", dashboard_path(:range => :year) %></li>
       			</ul>
       		</div>
       		<div class="pull-right">
       			<% if Bricata::Jobs.caching? %>
               		<% content_for :footer do %>
               		<script type="text/javascript">
               			setTimeout(function(){
               			location.reload();
               			},20000);
               		</script>
  	            	<% end %>
                	<li role='presentation' class='right last-cache-time'>
	               		Currently Caching <%= image_tag('icons/pager.gif', :size => '16x11') %>
    				</li>
    			<% else %>
       				<li role='presentation' class='right last-cache-time'>
       				<% if @last_cache.present? %>
       					Last updated: <%= display_time(@last_cache, true) %>
          				<% end %>
           			</li>
           		<% end %>
       		</div>
		</div>
		<div class="charts row12">
			<div id='box-holder'>
				<%= render 'severity_dashboard.html.erb' %>
			</div>
        	<%= render 'graph_dashboard.html.erb'%>
			<div class='secondary col-md-3 alpha'>
				<div class='dashboard-header statistics'>
					<span>Last 10 Unique Events</span>
					<%= link_to "See All", sessions_events_path %>
				</div>
				<ul class='box-list statistics'>
					<% @recent_events.each do |event| %>
					<li>
					    <% if event.signature %>
						<%= link_to truncate(event.signature.name, :length => 28), results_path(:title => "#{truncate(event.signature.name, :length => 40)}",
							"match_all"=>"true", "search"=>{"sensor"=>{"column"=>"signature", "operator"=>"is", "value"=> event.signature.sig_id } }), :title => event.signature.name %>
						<span>
							<%= number_with_delimiter (event.signature.events_count.zero? ? Event.count(:sig_id => event.signature.sig_id) : event.signature.events_count) %>
						</span>
					    <% else %>
						<span>Unknown signature (Nil).</span>
					    <% end %>
					</li>
					<% end %>
				</ul>
				<div class='dashboard-header statistics'>
					<span>Top 5 Classified Events</span>
					<%= link_to "See All", sessions_events_path %>
				</div>
				<ul class='box-list statistics'>
					<% @classifications.each do |classification| %>
					<li>
						<%= link_to truncate(classification.name, :length => 25), results_path(:title => "#{classification.name}",
						"match_all"=>"true", "search"=>{"sensor"=>{"column"=>"classification", "operator"=>"is", "value"=> classification.id } }), :title => classification.name %>
						<span><%= number_with_delimiter classification.events_count %></span>
					</li>
					<% end %>
				</ul>
        	</div>
        </div>
	</div>
</div>
